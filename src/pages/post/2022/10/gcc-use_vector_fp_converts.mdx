---
title: æ¢ç©¶ gcc æµ®ç‚¹æ•°ç²¾åº¦è½¬æ¢æ‰€ä½¿ç”¨çš„æŒ‡ä»¤ â€”â€” use_vector_fp_converts ä¼˜åŒ–
date: 2022-10-18T15:10:48+08:00
image: /images/2022/10/use_vector_fp_converts-test-results.png
tags:
    - gcc
    - æ€§èƒ½ä¼˜åŒ–
    - é—®é¢˜è§£å†³è®°å½•
---

åœ¨å­¦ä¹  [æµ®ç‚¹æ•°ç²¾åº¦è½¬æ¢æŒ‡ä»¤](/post/2022/09/csapp-3#æµ®ç‚¹æ•°ç²¾åº¦è½¬æ¢) æ—¶ï¼ŒCS:APP é‡Œæåˆ° gcc å¹¶ä¸ä½¿ç”¨ `vcvtss2sd`/`vcvtsd2ss`ï¼Œè€Œæ˜¯ä½¿ç”¨ `vunpcklps` & `vcvtps2pd` / `vmovddup` & `vcvtpd2psx`ï¼Œä½†æ˜¯æˆ‘ä½¿ç”¨ gcc 12.2.0 ç¼–è¯‘å¾—åˆ°çš„ç»“æœå°±æ˜¯ `vcvtss2sd`/`vcvtsd2ss`ã€‚å¯¹æ­¤ï¼ŒCS:APP æ²¡æœ‰æ·±ç©¶ï¼š

> It is unclear why GCC generates this code. There is neither benefit nor need to have the value duplicated within the XMM register.

ä½†æ˜¯ CS:APP é€‰æ‹©æ”¾å¼ƒåè€Œä¼šæ¿€å‘è¯»è€…çš„æ–—å¿—å•Šï¼ˆ

è™½ç„¶ä½†æ˜¯ï¼Œæˆ‘ç¡®å®æ²¡æƒ³åˆ°è¿™ç©æ„ä¼šè®©æˆ‘æ–­æ–­ç»­ç»­æäº†ä¸‰å¤©ï¼Œddl åˆè¦å¯„äº† ğŸŒš

<Excerpt />

## é—®é¢˜æè¿°

è¿™ä¸€é—®é¢˜å¯ä»¥ç”±ä¸‹é¢çš„ä»£ç æ‰€å±•ç¤ºï¼š

```c
double f2d(float x)
{
    return x;
}

float d2f(double x)
{
    return x;
}

double fp2d(float *x)
{
    return *x;
}

float dp2f(double *x)
{
    return *x;
}
```

å®ƒç¼–è¯‘æˆæ±‡ç¼–çš„ç»“æœæœ‰å¦‚ä¸‹å‡ ç§ï¼š

<Card title="ç¼–è¯‘ç»“æœ" fold>

æ±‡ç¼–ä¸­ä¸é‡è¦çš„éƒ¨åˆ†å·²çœå»ã€‚

A:

```nasm
f2d:
    cvtss2sd    %xmm0, %xmm0
    ret
d2f:
    cvtsd2ss    %xmm0, %xmm0
    ret
fp2d:
    pxor        %xmm0, %xmm0
    cvtss2sd    (%rdi), %xmm0
    ret
dp2f:
    pxor        %xmm0, %xmm0
    cvtsd2ss    (%rdi), %xmm0
    ret
```

Bï¼š

```nasm
f2d:
    unpcklps    %xmm0, %xmm0
    cvtps2pd    %xmm0, %xmm0
    ret
d2f:
    unpcklpd    %xmm0, %xmm0
    cvtpd2ps    %xmm0, %xmm0
    ret
fp2d:
    movss       (%rdi), %xmm0
    cvtps2pd    %xmm0, %xmm0
    ret
dp2f:
    movq        (%rdi), %xmm0
    cvtpd2ps    %xmm0, %xmm0
    ret
```

A with AVX2ï¼š

```nasm
f2d:
    vcvtss2sd   %xmm0, %xmm0, %xmm0
    ret
d2f:
    vcvtsd2ss   %xmm0, %xmm0, %xmm0
    ret
fp2d:
    vxorps      %xmm0, %xmm0, %xmm0
    vcvtss2sd   (%rdi), %xmm0, %xmm0
    ret
dp2f:
    vxorps      %xmm0, %xmm0, %xmm0
    vcvtsd2ss   (%rdi), %xmm0, %xmm0
    ret
```

B with AVX2ï¼š

```nasm
f2d:
    vunpcklps   %xmm0, %xmm0, %xmm0
    vcvtps2pd   %xmm0, %xmm0
    ret
d2f:
    vmovddup    %xmm0, %xmm0
    vcvtpd2psx  %xmm0, %xmm0
    ret
fp2d:
    vmovss      (%rdi), %xmm0
    vcvtps2pd   %xmm0, %xmm0
    ret
dp2f:
    vmovq       (%rdi), %xmm0
    vcvtpd2psx  %xmm0, %xmm0
    ret
```

</Card>

| å‡½æ•° |          A          |            B            |      A with AVX2       |        B with AVX2        |
| :--: | :-----------------: | :---------------------: | :--------------------: | :-----------------------: |
| f2d  |     `cvtss2sd`      | `unpcklps` & `cvtps2pd` |      `vcvtss2sd`       | `vunpcklps` & `vcvtps2pd` |
| d2f  |     `cvtsd2ss`      | `unpcklpd` & `cvtpd2ps` |      `vcvtsd2ss`       | `vmovddup` & `vcvtpd2psx` |
| fp2d | `pxor` & `cvtss2sd` |  `movss` & `cvtps2pd`   | `vxorps` & `vcvtss2sd` |  `vmovss` & `vcvtps2pd`   |
| dp2f | `pxor` & `cvtsd2ss` |   `movq` & `cvtpd2ps`   | `vxorps` & `vcvtsd2ss` |  `vmovq` & `vcvtpd2psx`   |

é—®é¢˜åœ¨äºï¼Œgcc ä¸ºä»€ä¹ˆ/åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šç”Ÿæˆå¦‚ B æ‰€ç¤ºçš„æŒ‡ä»¤ã€‚å…¶ä¸­ï¼Œä½¿ç”¨ä¸¤æ¡ç†è§£èµ·æ¥éƒ½ä¸å¤ªå®¹æ˜“çš„æŒ‡ä»¤ï¼ˆ`unpcklps`ã€`cvtps2pd`ï¼‰æ¥ä»£æ›¿æŒ‡ä»¤é›†ä¸­è‡ªå¸¦çš„ `cvtss2sd`/`cvtsd2ss` æœ€ä»¤äººè´¹è§£ã€‚è€Œ source ä¸ºæŒ‡é’ˆçš„å¦å¤–ä¸¤ä¸ªå‡½æ•°æ˜¯å— [performance - Why don't GCC and Clang use cvtss2sd \[memory\]? - Stack Overflow](https://stackoverflow.com/questions/16597587/why-dont-gcc-and-clang-use-cvtss2sd-memory) å¯å‘ã€‚

æˆ‘å…ˆå°è¯•äº†å„ç§å…³é”®è¯ç”¨æœç´¢å¼•æ“è¿›è¡Œæœç´¢ï¼Œå‡æœªæ‰¾åˆ°ç­”æ¡ˆã€‚

## gcc ç‰ˆæœ¬çš„å®šä½

ä½¿ç”¨ [Compiler Explorer](https://gcc.godbolt.org/) è¿›è¡Œå°è¯•ï¼Œå¾ˆå¿«å°±èƒ½ç¡®è®¤ï¼Œæ˜¯åœ¨ gcc 4.8.5 / 4.9.0 ä¹‹é—´è¡Œä¸ºå‡ºç°äº†å˜åŒ–ã€‚

äºæ˜¯ï¼Œæˆ‘å…ˆçœ‹äº† [gcc 4.9 changes](https://gcc.gnu.org/gcc-4.9/changes.html)ï¼Œåˆåœ¨ commit log é‡Œå¤§åŠ›æœç´¢â€œ`cvtss2sd`â€<wbr/>â€œ`cvtsd2ss`â€<wbr/>â€œ`unpcklp`â€<wbr/>â€œfloating pointâ€<wbr/>â€œconvertâ€â€¦â€¦éƒ½æ²¡æ‰¾åˆ°ç›¸å…³å†…å®¹ã€‚

## å…·ä½“ commit çš„å®šä½ï¼šgit bisect / ç¼–è¯‘ gcc

åœ¨å„ç§æœç´¢éƒ½å¤±è´¥åï¼Œæˆ‘å†³å®šä½¿ç”¨ `git bisect` æ‰¾åˆ°è¡Œä¸ºå‡ºç°å˜åŒ–çš„ commitã€‚

è¦ bisectï¼Œå°±å¾—ç¼–è¯‘ gcc 4.8.5 ~ 4.9.0ï¼Œæ­¥éª¤å¤§è‡´å¦‚ä¸‹ï¼š

1.  å°† gcc ä»£ç  clone ä¸‹æ¥: `git clone https://github.com/gcc-mirror/gcc --branch releases/gcc-4.9 --depth 50000`
2.  åˆ›å»º `build` ç›®å½•
3.  åœ¨ `build` ç›®å½•ä¸‹è¿è¡Œ `gcc` ä»“åº“æ ¹ç›®å½•çš„ `configure` è„šæœ¬
4.  åœ¨ `build` ç›®å½•ä¸‹è¿è¡Œ `make`

å…¶ä¸­ï¼Œ`configure` çš„é…ç½®å¯ä»¥å‚è€ƒ [Installing GCC: Configuration - GNU Project](https://gcc.gnu.org/install/configure.html)ï¼Œä½†æˆ‘åªæ˜¯ bisect ä¸€ä¸‹ï¼Œå°±æ²¡ä»”ç»†ç ”ç©¶ã€‚

è¿‡ç¨‹ä¸­èµ°çš„å¼¯è·¯å°±ä¸ä¸€ä¸€ç»†è¯´äº†ï¼Œåªè¯´ä¸€ä¸‹æœ€ç»ˆçš„è§£å†³æ–¹æ¡ˆä¸­é‡åˆ°çš„å‡ ä¸ªä¸»è¦é—®é¢˜ã€‚

æœ€ç»ˆçš„ç¼–è¯‘å‘½ä»¤ä¸º:

```sh
CC=gcc-4.8
CXX=g++-4.8
make distclean
../gcc/configure --enable-languages=c --disable-multilib --disable-libsanitizer
make -j$(nproc)
```

### è¯­è¨€æ ‡å‡†é—®é¢˜

å› ä¸ºç¼–è¯‘çš„æ˜¯å¤šå¹´å‰çš„ gcc 4.8~4.9ï¼Œç”¨ç°åœ¨çš„ç¼–è¯‘å™¨ä¼šé‡åˆ°ä¸€äº›è¯­è¨€æ ‡å‡†ä¸åŒçš„é—®é¢˜ã€‚ä¿®æ”¹ç¼–è¯‘é€‰é¡¹å¤§æ¦‚èƒ½è§£å†³é—®é¢˜ï¼Œä½†æ”¹èµ·æ¥éº»çƒ¦ï¼Œä¹Ÿä¸è§å¾—èƒ½è§£å†³æ‰€æœ‰é—®é¢˜ï¼Œä¸å¦‚ç›´æ¥ç”¨æ—§ç‰ˆ gcc æ¥ç¼–è¯‘ã€‚

~~ä½†æ˜¯ç°åœ¨ç›®æ ‡å°±æ˜¯ç¼–è¯‘æ—§ç‰ˆ gccï¼Œä½ å“ªæ¥çš„æ—§ç‰ˆ gcc ç”¨æ¥ç¼–è¯‘ï¼Ÿ~~

ç”¨æ—§ç‰ˆ gcc è§£å†³ç¼–è¯‘æ—§ç‰ˆ gcc é‡åˆ°çš„é—®é¢˜çœ‹èµ·æ¥å¾ˆçŸ›ç›¾ï¼Œä½†æˆ‘ä»¬è¦è§£å†³çš„æ˜¯ç¼–è¯‘ä¸¤ä¸ªç‰ˆæœ¬ä¹‹é—´çš„ä¸€å † commitï¼Œè€Œè·å¾—ä¸€ä¸ªç”¨æ¥ç¼–è¯‘çš„æ—§ç‰ˆ gcc åªéœ€è¦ä¸€ä¸ª gcc release çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚è¿™ä¸ªç”¨æ¥ç¼–è¯‘çš„æ—§ç‰ˆ gcc å¯ä»¥ç”¨å„ç§æ–¹å¼ä¸‹è½½ä¸€ä¸ªï¼Œè€Œæˆ‘ç”¨çš„æ˜¯ Arch Linuxï¼Œå°±è£…äº† [AUR é‡Œçš„ gcc48](https://aur.archlinux.org/packages/gcc48)ã€‚

è·å¾—äº†ä¸€ä¸ªæ—§ç‰ˆ gcc åï¼Œè¿è¡Œ `configure` æ—¶ä¿®æ”¹ç¯å¢ƒå˜é‡ `CC` å’Œ `CXX` å³å¯ä½¿ç”¨ã€‚

P.S. æˆ‘æœ¬æ¥æƒ³ç”¨ AUR çš„ PKGBUILD æ¥ç¼–è¯‘ï¼Œä½†èƒ½ç¼–è¯‘ release ä¸ä»£è¡¨èƒ½ç¼–è¯‘å„ä¸ª commitï¼Œç„¶åè¸©å„ç§å‘è¸©äº†åŠå¤©..

### struct ucontext

è¿˜ä¼šé‡åˆ°ä¸€ä¸ªç¼–è¯‘é”™è¯¯: `md-unwind-support.h:65:47: error: dereferencing pointer to incomplete type 'struct ucontext'`

å°†ç›¸åº”ä»£ç ä¸­çš„ `ucontext` ä¿®æ”¹ä¸º `ucontext_t` å³å¯ã€‚

reference: [How to compile gcc 6.4.0 with gcc 7.2 in Archlinux - Stack Overflow](https://stackoverflow.com/questions/46999900/how-to-compile-gcc-6-4-0-with-gcc-7-2-in-archlinux)

### libsanitizer

è¿˜ä¼šé‡åˆ°ä¸€äº›ç¼–è¯‘é”™è¯¯ï¼Œåœ¨æœç´¢å…¶ä¸­ä¸€ä¸ªçš„è§£å†³æ–¹æ¡ˆæ—¶ï¼Œæˆ‘æ‰¾åˆ°äº† [ä¸€æ¬¡ä»¤äººåè¡€çš„ ubuntu æºç å®‰è£… gcc-5.4.0 ç»å†\_äº¿é›¶è´°è‚†çš„åšå®¢-CSDN åšå®¢\_ubuntu å®‰è£… gcc5.4.0](https://blog.csdn.net/tuibianhuaisheng/article/details/115399019)ã€‚

è¿™ç¯‡åšå®¢ä¹Ÿæåˆ°äº†ä¸Šé¢è¯´çš„ `struct ucontext` çš„é—®é¢˜ï¼Œè€Œä»”ç»†ä¸€çœ‹å°±ä¼šå‘ç°ï¼Œå‰©ä¸‹å…¶ä»–é—®é¢˜å…¨éƒ½æ˜¯ `libsanitizer` é‡Œçš„ï¼Œè€Œæˆ‘ç ”ç©¶è¿™ä¸ªé—®é¢˜ä¸éœ€è¦ `libsanitizer`ï¼Œç›´æ¥ `--disable-libsanitizer` å°±èƒ½è§£å†³è¿™ä¸€å †ç¼–è¯‘é”™è¯¯è¿˜èƒ½ç¼©çŸ­ç¼–è¯‘ç”¨æ—¶ã€‚

### make distclean

ä¿®æ”¹å„ç§é€‰é¡¹æˆ–è€…æ›´æ¢ commit åï¼Œå¦‚æœç›´æ¥ `make` å®¹æ˜“å‡ºé—®é¢˜ï¼Œå¯ä»¥å…ˆ `make distclean` æ¥é‡ç½®ã€‚

### git bisect

åœ¨å¤„ç†å®Œä¸Šé¢å‡ ä¸ªé—®é¢˜ä¹‹åï¼Œç¼–è¯‘å°±å¾ˆé¡ºåˆ©äº†ã€‚åœ¨æˆ‘ 8C16T çš„ AMD Ryzen 7 4800H ä¸Šï¼Œç¼–è¯‘ä¸€æ¬¡å¤§çº¦éœ€è¦ 9minã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºåŸé—®é¢˜å¯ä»¥çœ‹æˆæ˜¯åœ¨æ›´è€çš„ç‰ˆæœ¬å‡ºç°ï¼Œå³æ–°ç‰ˆæœ¬ good è€ç‰ˆæœ¬ badï¼Œä½† `git bisect` é»˜è®¤æ˜¯è€ç‰ˆæœ¬ good æ–°ç‰ˆæœ¬ badï¼Œè¿™é‡Œå®¹æ˜“æåï¼Œéœ€è¦æ³¨æ„ã€‚ï¼ˆ`git bisect` å¯ä»¥æŠŠ good/bad æ”¹æˆ old/newï¼Œä½†æˆ‘æ‡’å¾—ï¼ˆç ”ç©¶æ€ä¹ˆï¼‰æ”¹äº†ã€‚ï¼‰

bisect æ‰¾åˆ°çš„ commit æ˜¯ [915e8e6e](https://github.com/gcc-mirror/gcc/commit/915e8e6eec05fb595d445cb738e4875d607ce126)ã€‚

ä»è¿™ä¸ª commit çš„å†…å®¹å¯ä»¥å¾—çŸ¥ï¼Œé‚£äº›çœ‹èµ·æ¥æœ‰äº›å¥‡æ€ªçš„ç¼–è¯‘ç»“æœæ˜¯ä¸€ä¸ªå«åš `use_vector_fp_converts` çš„ä¼˜åŒ–çš„ç»“æœã€‚è¿™ä¸ª commit ä½¿å¾—è¿™ä¸ªä¼˜åŒ–åªå¯¹ amdfam10 æ¶æ„ç”Ÿæ•ˆï¼Œåœ¨æ–°ç‰ˆ gcc ä¸­ä»å¯ä½¿ç”¨ `-mtune=amdfam10` é€‰é¡¹è§‚å¯Ÿåˆ°è¿™ä¸€è¡Œä¸ºï¼ˆä¹Ÿå¯ä»¥ä½¿ç”¨ `-mtune-ctrl=use_vector_fp_converts` æ¥å¯ç”¨è¿™ä¸ªä¼˜åŒ–ï¼‰ã€‚ä»£ç ä¸­å¯¹è¿™ä¸€ä¼˜åŒ–ç»™å‡ºçš„ç†ç”±æ˜¯â€œavoids partial write to the destinationâ€ï¼Œä¹Ÿå°±æ˜¯è¯´ `cvtss2sd`/`cvtsd2ss` åªä¿®æ”¹ç›®æ ‡å¯„å­˜å™¨çš„ä½ä½ï¼Œå¯èƒ½å¯¼è‡´æ•ˆç‡ä½ã€‚

## ä¼˜åŒ–æœ€ç»ˆè¢«å…³é—­çš„åŸå› 

é”å®šäº†é—®é¢˜å‡ºç°çš„ commitï¼Œæ¥ä¸‹æ¥å°±æ˜¯æœç´¢è¿™ä¸ª commit ä¿®æ”¹çš„åŸå› äº†ã€‚

[åœ¨ `gcc-patches` é‡Œæœç´¢ `use_vector_fp_converts`](https://www.mail-archive.com/search?l=gcc-patches%40gcc.gnu.org&q=use_vector_fp_converts)ï¼Œç„¶åå†é¡ºç€é‚®ä»¶å†…å®¹æ‰¾ï¼Œå°±å¯ä»¥æ‰¾åˆ°ç›¸å…³é‚®ä»¶ï¼š

-   [\[Google\] X86_TUNE_USE_VECTOR_CONVERTS adjustment](https://www.mail-archive.com/gcc-patches@gcc.gnu.org/msg59433.html)
-   [\[PATCH\] disable use_vector_fp_converts for m_CORE_ALL](https://www.mail-archive.com/gcc-patches@gcc.gnu.org/msg61372.html) ([157ca3e9](https://github.com/gcc-mirror/gcc/commit/157ca3e989605194001568cc1864603b32fbd025))
-   [Revisit Core tunning flags](https://www.mail-archive.com/gcc-patches@gcc.gnu.org/msg62058.html)
-   [Re: \[PATCH i386\]: Enable push/pop in pro/epilogue for modern CPUs](https://www.mail-archive.com/gcc-patches@gcc.gnu.org/msg46926.html)

ä»¤æˆ‘è‡ªé—­çš„æ˜¯..ç›´æ¥æœç´¢ `cvtss2sd`/`cvtsd2ss` å°±èƒ½æœåˆ°è¿™äº›é‚®ä»¶ ğŸ˜µ ä¸ºä»€ä¹ˆ bisect å‡ºæ¥æ‰æƒ³ç€åœ¨é‚®ä»¶åˆ—è¡¨é‡Œæœå‘¢...ï¼ˆä½æƒ…å•†ï¼šwssbï¼›é«˜æƒ…å•†ï¼šè¿˜æ˜¯ mailing list ä½¿ç”¨ç»éªŒä¸è¶³ ğŸ˜¢ï¼‰

æ€»ç»“ä¸€ä¸‹è¿™äº›é‚®ä»¶çš„å†…å®¹ï¼Œå°±æ˜¯ï¼š

1.  åœ¨ä¸€äº› Intel CPU ä¸Šï¼ŒæŸäº› test case ä¸Šå¯ç”¨ `use_vector_fp_converts` æ›´å¿«ï¼Œå¦ä¸€äº› test case ä¸Šä¸å¯ç”¨æ›´å¿«ã€‚
2.  åœ¨å¯ç”¨ `use_vector_fp_converts` æ›´å¿«çš„ test case ä¸Šï¼Œå¯ä»¥é€šè¿‡åœ¨ `cvtss2sd`/`cvtsd2ss` ä¹‹å‰å°† XMM å¯„å­˜å™¨æ¸…ç©ºï¼ˆ`pxor %xmm0, %xmm0`ï¼‰ä»¥é¿å…åªæ›´æ–°ä½ä½å¸¦æ¥çš„æ€§èƒ½æŸå¤±ï¼Œä»è€Œè¾¾åˆ°å’Œå¯ç”¨ `use_vector_fp_converts` å·®ä¸å¤šçš„æ€§èƒ½ã€‚æ‰€ä»¥ [157ca3e9](https://github.com/gcc-mirror/gcc/commit/157ca3e989605194001568cc1864603b32fbd025) å°±å¯¹ `m_CORE_ALL` å…³é—­äº†è¿™ä¸ªä¼˜åŒ–å¹¶ä¸”åœ¨éœ€è¦æ—¶å…ˆå°† XMM å¯„å­˜å™¨æ¸…ç©ºã€‚
3.  åœ¨ [Re: \[PATCH\] disable use_vector_fp_converts for m_CORE_ALL](https://www.mail-archive.com/gcc-patches@gcc.gnu.org/msg62712.html) ä¸­ï¼ŒHonza è¡¨ç¤ºå¯ä»¥å…ˆæŠŠä¸Šé¢é‚£ä¸ª patch commit äº†ï¼Œä»–æµ‹è¯•ä¸€ä¸‹å†å†³å®šæ˜¯å¦å¯¹ `m_GENERIC` ä¹Ÿå…³é—­è¿™ä¸ªä¼˜åŒ–ï¼Œæ‰€ä»¥ 157ca3e9ï¼ˆå¯¹ `m_CORE_ALL` å…³é—­ä¼˜åŒ–å¹¶åœ¨éœ€è¦æ—¶æ¸…ç©º XMMï¼‰å’Œ 915e8e6eï¼ˆå¯¹ `m_GENERIC` å…³é—­ä¼˜åŒ–ï¼‰åˆ†æˆäº†ä¸¤ä¸ª commitã€‚

## ä¼˜åŒ–æœ€åˆè¢«æ·»åŠ çš„åŸå› 

ç»§ç»­è¿½æ ¹æº¯æºä¸‹å»ï¼Œé€šè¿‡ `git blame` æ¥æ‰¾åˆ°ä¸€å¼€å§‹æ·»åŠ è¿™ä¸ªä¼˜åŒ–çš„åŸå› ã€‚

é¦–å…ˆæ‰¾åˆ° [54723b46](https://github.com/gcc-mirror/gcc/commit/54723b46231868447f68ed5322d916bd05bffae3)ï¼Œè¿™ä¸ª commit å°† `TARGET_USE_VECTOR_FP_CONVERTS` ä» `TARGET_USE_VECTOR_CONVERTS` ä¸­æŠ½ç¦»å‡ºæ¥æˆä¸ºå•ç‹¬çš„ä¼˜åŒ–å¼€å…³ã€‚

ç„¶åæ‰¾åˆ° [4845dbb5](https://github.com/gcc-mirror/gcc/commit/4845dbb50ed31ad03c579364e4b70bbe90e7af99)ï¼Œè¿™ä¸ª commit æ·»åŠ äº† `X86_USE_VECTOR_CONVERTS`ï¼Œå³ `X86_TUNE_USE_VECTOR_FP_CONVERTS` çš„å‰èº«ã€‚

4845dbb5 çš„é‚®ä»¶æ˜¯ [SSE conversion optimization](https://gcc.gnu.org/pipermail/gcc-patches/2007-September/225078.html)ï¼Œé‡Œé¢å†™çš„å¾ˆç®€ç•¥ï¼Œå°±æ˜¯â€œAmdfam10 preffers doing packed conversions destinating SSE register rather than scalarâ€ã€‚

åªä¸è¿‡ [performance - Why don't GCC and Clang use cvtss2sd \[memory\]? - Stack Overflow](https://stackoverflow.com/questions/16597587/why-dont-gcc-and-clang-use-cvtss2sd-memory) é‡Œè¿˜æ˜¯æœ‰ä¸€äº›è§£é‡Šçš„ï¼Œåæ­£ç®€å•æ¥è¯´å°±æ˜¯ partial regisiter update ä¼šæœ‰æ€§èƒ½æŸå¤±ã€‚

## å¯¹ m_CORE_ALLã€m_GENERIC å¯ç”¨ä¼˜åŒ–çš„åŸå› 

å¯ä»¥å‘ç°ï¼Œä¸€å¼€å§‹æœ‰è¿™ä¸ªä¼˜åŒ–æ—¶ï¼Œæ˜¯åªå¯¹ `m_AMDFAM10` å¯ç”¨çš„ï¼Œè¿™å’Œç°åœ¨æ˜¯ä¸€æ ·çš„ï¼Œä¸ºä»€ä¹ˆä¸­é—´ç»•äº†ä¸€åœˆåˆå›åˆ°æœ€å¼€å§‹çš„é€‰æ‹©å‘¢ï¼Ÿç»§ç»­å¯»æ‰¾å¯¹ `m_CORE_ALL` å’Œ `m_GENERIC` å¯ç”¨è¿™ä¸ªä¼˜åŒ–çš„åŸå› ã€‚

é¦–å…ˆæ‰¾åˆ° [3ad20bd4](https://github.com/gcc-mirror/gcc/commit/3ad20bd44836e57453b743466f1ca0d591bd10ac)ï¼Œè¿™ä¸ª commit æŠŠç›¸å…³ä»£ç æŒªäº†ä¸ªä½ç½®ã€‚

ç„¶åæ‰¾åˆ° [3a579e09](https://github.com/gcc-mirror/gcc/commit/3a579e0930abe3ed91977a71284021399339860c)ï¼Œè¿™ä¸ª commit æŠŠ `m_CORE2I7` æ”¹æˆäº† `m_CORE_ALL`ã€‚

ç„¶åæ‰¾åˆ° [3a4ffde6](https://github.com/gcc-mirror/gcc/commit/3a4ffde68cfc6fee3c20d282d6690f2569e2fffa)ï¼Œè¿™ä¸ª commit ä¿®æ”¹äº†ä¸€å †å¤„ç†å™¨æ¶æ„çš„ bitmaskï¼Œç„¶å..æŠŠ `m_AMDFAM10` å’Œ `m_CORE2I7` æ¢äº†ä¸ªä½ç½® ğŸ¤”

ç„¶åæ‰¾åˆ° [ab247762](https://github.com/gcc-mirror/gcc/commit/ab2477624b15b5d1fe43972f8f4d6082c6893624)ï¼Œè¿™ä¸ª commit æ–°å¢äº† `m_CORE2I7` æ¶æ„å¹¶ä¸”ä¸ºå®ƒå¯ç”¨äº† `X86_TUNE_USE_VECTOR_FP_CONVERTS`ã€‚è¿™ä¸ª patch çš„é‚®ä»¶æ˜¯ [0005-Switch-Core-2-to-new-tuning](https://gcc.gnu.org/pipermail/gcc-patches/2010-November/300958.html)ï¼Œç»™å‡ºçš„åŸå› æ˜¯ Core 2/i7 æ¯”è¾ƒé€‚åˆä½¿ç”¨ generic tuningï¼Œè€Œæ­¤æ—¶ `X86_TUNE_USE_VECTOR_FP_CONVERTS` æ˜¯å¯¹ `m_GENERIC` å¯ç”¨çš„ï¼Œå°±ä¹Ÿå¯¹ `m_CORE2I7` å¯ç”¨äº†ã€‚

è¿™æ—¶å†å›å¤´çœ‹ä¸Šé¢æ‰¾åˆ°çš„ [54723b46](https://github.com/gcc-mirror/gcc/commit/54723b46231868447f68ed5322d916bd05bffae3)ï¼Œè¿™ä¸ª commit å°† `TARGET_USE_VECTOR_CONVERTS || TARGET_GENERIC` æ”¹æˆäº† `TARGET_USE_VECTOR_FP_CONVERTS`ï¼Œæ‰€ä»¥è¦ blame è¿™ä¸ª `|| TARGET_GENERIC`ã€‚

æœ€åæ‰¾åˆ°æ˜¯ [bf019a1f](https://github.com/gcc-mirror/gcc/commit/bf019a1f7f992a1feb985c4b656e527475e73a30) æ·»åŠ äº† `|| TARGET_GENERIC`ã€‚è¿™ä¸ª patch çš„é‚®ä»¶æ˜¯ [PR target/33396](https://gcc.gnu.org/pipermail/gcc-patches/2007-September/225425.html)ï¼Œæ—¶é—´ä¸Šç´§è·Ÿç€æœ€åˆçš„ 4845dbb5ï¼Œè€Œ changelog å’Œé‚®ä»¶é‡Œåªæåˆ°äº†æ·»åŠ  `TARGET_SSE_MATH` è€Œæ²¡æœ‰æåˆ°æ·»åŠ  `TARGET_GENERIC` çš„åŸå› ï¼Œå¹¶ä¸”è¿™å°é‚®ä»¶è¿˜æ²¡äººå›å¤ã€‚

è‡³æ­¤ï¼Œæˆ‘å·²ç»ä¸çŸ¥é“èƒ½å¦‚ä½•ç»§ç»­æ¢ç©¶ä¸‹å»äº†ã€‚æˆ‘æ„Ÿè§‰å¯èƒ½æ˜¯ï¼š

1.  [SSE conversion optimization](https://gcc.gnu.org/pipermail/gcc-patches/2007-September/225078.html) ä¸­æåˆ°â€œWe are now testing if the patch is good for genericâ€ï¼Œå¯èƒ½ä»–è‡ªå·±æµ‹è¯•ä¹‹åå› ä¸ºæŸäº›åŸå› å¾—åˆ°äº†è¿™ä¸ªä¼˜åŒ– good for generic çš„ç»“è®ºï¼Œå°± commit äº†ï¼Œä¹Ÿæ²¡å†è§£é‡Šï¼›
2.  æˆ–è€…æ˜¯ï¼Œ[PR target/33396](https://gcc.gnu.org/pipermail/gcc-patches/2007-September/225425.html) é‡Œæåˆ°äº†â€œfailure with 32bit genericâ€ï¼Œå¯èƒ½æ˜¯æµ‹è¯•çš„æ—¶å€™åŠ ä¸Šäº† `TARGET_GENERIC`ï¼Œåæ¥å¿˜è®°åˆ æ‰äº† ğŸ¤”
3.  æˆ–è€…æ˜¯ï¼Œæœ‰ä»€ä¹ˆå…¶ä»–åŸå› ï¼Œä½†å¿˜è®°å†™åœ¨ log / é‚®ä»¶é‡Œäº†ï¼Œæˆ–è€…å†™åœ¨æŸä¸ªéšç§˜çš„è§’è½æˆ‘æ²¡æ‰¾åˆ°ã€‚

åæ­£ä¸ç®¡æ˜¯ä»€ä¹ˆåŸå› ï¼Œbf019a1f éƒ½æ˜¯ä¸€ä¸ª commit åšäº†ä¸¤ä»¶äº‹ï¼Œè¿˜åªå†™äº†ä¸€ä»¶äº‹çš„ changelogï¼Œå¯¼è‡´è¿™æˆäº†ä¸€ä¸ªè°œã€‚

## ä¸å…¶ä»–ç¼–è¯‘å™¨çš„å¯¹æ¯”

ä½¿ç”¨ [Compiler Explorer](https://gcc.godbolt.org/) çœ‹ä¸€ä¸‹å…¶ä»–ç¼–è¯‘å™¨æ˜¯æ€ä¹ˆåšçš„ã€‚

clang: æ— è®ºæ˜¯å¦ `-mtune=amdfam10` éƒ½æ²¡æœ‰ `use_vector_fp_converts`ã€‚

MSVC: æ— è®ºæ˜¯å¦ `-mtune=amdfam10` éƒ½æ˜¯ source in register åˆ™ `cvtss2sd`/`cvtsd2ss`ï¼Œsource in memory åˆ™è¡¨ç°å‡º `use_vector_fp_converts` çš„è¡Œä¸ºã€‚

ä½†æ˜¯æˆ‘å¹¶ä¸çŸ¥é“å¦‚ä½•ç ”ç©¶å…¶ä»–ç¼–è¯‘å™¨ä¸ºä»€ä¹ˆåšå‡ºè¿™æ ·çš„é€‰æ‹© ğŸ˜¢

## æ€§èƒ½æµ‹è¯•

æœ€åæ¥å®é™…æµ‹è¯•ä¸€ä¸‹è¿™ä¸ªä¼˜åŒ–çš„æ€§èƒ½ã€‚

æµ‹è¯•ä½¿ç”¨çš„ä»£ç ä¸º [\[PATCH\] disable use_vector_fp_converts for m_CORE_ALL](https://www.mail-archive.com/gcc-patches@gcc.gnu.org/msg61372.html) ä¸­çš„ `1.c` å’Œ `2.c`ï¼Œä½†åŸæ¥çš„ `2.c` ç”¨æ—¶å¤ªçŸ­ï¼Œæ‰€ä»¥æŠŠå¾ªç¯èŒƒå›´æ”¹æˆäº† `1ll << 32`ï¼š

<Card fold title="æµ‹è¯•ç”¨ä»£ç ">

`1.c`:

```c
float total = 0.2;
int k = 5;

int main()
{
    int i;

    for (i = 0; i < 1000000000; i++)
    {
        total += (0.5 + k);
    }

    return total == 0.3;
}
```

`2.c`:

```c
double b[1024];

float a[1024];

int main()
{
    for(long i = 0 ; i < (1ll << 32); i++)
      a[i & 1023] = a[i & 1023] * (float)b[i & 1023];
    return (int)a[512];
}
```

</Card>

æµ‹è¯•ä½¿ç”¨çš„ç¼–è¯‘é€‰é¡¹æœ‰ï¼š

1.  `-O2 -mtune-ctrl=^use_vector_fp_converts`
2.  `-O2 -mtune-ctrl=^use_vector_fp_converts -mavx2`
3.  `-O2 -mtune-ctrl=use_vector_fp_converts`
4.  `-O2 -mtune-ctrl=use_vector_fp_converts -mavx2`

å…¶ä¸­å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨ 2 å·ç¼–è¯‘é€‰é¡¹ç¼–è¯‘ `2.c` æ—¶ä¼šé€šè¿‡å°† `vcvtsd2ss` æŒ‡ä»¤çš„ç¬¬äºŒä¸ª operand è®¾ä¸º `%xmm1` æ¥ä»£æ›¿ `pxor %xmm0, %xmm0` ä»¥è¾¾åˆ°æ¸…ç©º `%xmm0` çš„æ•ˆæœã€‚

ä¸ºäº†æµ‹è¯•æ¸…ç©º XMM å¯„å­˜å™¨çš„æ•ˆæœï¼Œåœ¨è¿™ 4 ç§ç¼–è¯‘é€‰é¡¹ä¹‹å¤–ï¼Œè¿˜å¯¹ `2.c` å¢è®¾äº†æ‰‹åŠ¨åˆ æ‰ç”¨äºæ¸…ç©º `%xmm0` çš„æŒ‡ä»¤çš„ä¸¤ä»½æ±‡ç¼–ä»£ç ã€‚

æ‰€ä»¥æ€»å…±æœ‰ 10 ä»½æ±‡ç¼–ä»£ç ç”¨äºæµ‹è¯•ï¼š

-   1-1: `1.c`ï¼Œ`-O2 -mtune-ctrl=^use_vector_fp_converts`
-   1-2: `1.c`ï¼Œ`-O2 -mtune-ctrl=^use_vector_fp_converts -mavx2`
-   1-3: `1.c`ï¼Œ`-O2 -mtune-ctrl=use_vector_fp_converts`
-   1-4: `1.c`ï¼Œ`-O2 -mtune-ctrl=use_vector_fp_converts -mavx2`
-   2-1: `2.c`ï¼Œ`-O2 -mtune-ctrl=^use_vector_fp_converts`
-   2-2: `2.c`ï¼Œ`-O2 -mtune-ctrl=^use_vector_fp_converts -mavx2`
-   2-3: `2.c`ï¼Œ`-O2 -mtune-ctrl=use_vector_fp_converts`
-   2-4: `2.c`ï¼Œ`-O2 -mtune-ctrl=use_vector_fp_converts -mavx2`
-   2-5: `2.c`ï¼Œ`-O2 -mtune-ctrl=^use_vector_fp_converts`ï¼Œç„¶ååˆ æ‰ `pxor %xmm0, %xmm0`
-   2-6: `2.c`ï¼Œ`-O2 -mtune-ctrl=^use_vector_fp_converts -mavx2`ï¼Œç„¶åå°† `vcvtsd2ss` çš„ç¬¬äºŒä¸ª operand æ”¹ä¸º `%xmm0`ã€‚

<Card fold title="æµ‹è¯•ç”¨æ±‡ç¼–ä»£ç ">

<Card fold title="1-1">

```nasm
	.file	"1.c"
	.text
	.section	.text.startup,"ax",@progbits
	.p2align 4
	.globl	main
	.type	main, @function
main:
.LFB0:
	.cfi_startproc
	pxor	%xmm1, %xmm1
	movss	total(%rip), %xmm0
	movl	$1000000000, %eax
	cvtsi2sdl	k(%rip), %xmm1
	addsd	.LC0(%rip), %xmm1
	.p2align 4,,10
	.p2align 3
.L2:
	cvtss2sd	%xmm0, %xmm0
	addsd	%xmm1, %xmm0
	cvtsd2ss	%xmm0, %xmm0
	subl	$1, %eax
	jne	.L2
	movss	%xmm0, total(%rip)
	xorl	%edx, %edx
	cvtss2sd	%xmm0, %xmm0
	ucomisd	.LC1(%rip), %xmm0
	setnp	%dl
	cmove	%edx, %eax
	ret
	.cfi_endproc
.LFE0:
	.size	main, .-main
	.globl	k
	.data
	.align 4
	.type	k, @object
	.size	k, 4
k:
	.long	5
	.globl	total
	.align 4
	.type	total, @object
	.size	total, 4
total:
	.long	1045220557
	.section	.rodata.cst8,"aM",@progbits,8
	.align 8
.LC0:
	.long	0
	.long	1071644672
	.align 8
.LC1:
	.long	858993459
	.long	1070805811
	.ident	"GCC: (GNU) 12.2.0"
	.section	.note.GNU-stack,"",@progbits
```

</Card>

<Card fold title="1-2">

```nasm
	.file	"1.c"
	.text
	.section	.text.startup,"ax",@progbits
	.p2align 4
	.globl	main
	.type	main, @function
main:
.LFB0:
	.cfi_startproc
	vxorps	%xmm1, %xmm1, %xmm1
	vmovss	total(%rip), %xmm0
	movl	$1000000000, %eax
	vcvtsi2sdl	k(%rip), %xmm1, %xmm1
	vaddsd	.LC0(%rip), %xmm1, %xmm1
	.p2align 4,,10
	.p2align 3
.L2:
	vcvtss2sd	%xmm0, %xmm0, %xmm0
	vaddsd	%xmm1, %xmm0, %xmm0
	vcvtsd2ss	%xmm0, %xmm0, %xmm0
	subl	$1, %eax
	jne	.L2
	vmovss	%xmm0, total(%rip)
	xorl	%edx, %edx
	vcvtss2sd	%xmm0, %xmm0, %xmm0
	vucomisd	.LC1(%rip), %xmm0
	setnp	%dl
	cmove	%edx, %eax
	ret
	.cfi_endproc
.LFE0:
	.size	main, .-main
	.globl	k
	.data
	.align 4
	.type	k, @object
	.size	k, 4
k:
	.long	5
	.globl	total
	.align 4
	.type	total, @object
	.size	total, 4
total:
	.long	1045220557
	.section	.rodata.cst8,"aM",@progbits,8
	.align 8
.LC0:
	.long	0
	.long	1071644672
	.align 8
.LC1:
	.long	858993459
	.long	1070805811
	.ident	"GCC: (GNU) 12.2.0"
	.section	.note.GNU-stack,"",@progbits
```

</Card>

<Card fold title="1-3">

```nasm
	.file	"1.c"
	.text
	.section	.text.startup,"ax",@progbits
	.p2align 4
	.globl	main
	.type	main, @function
main:
.LFB0:
	.cfi_startproc
	pxor	%xmm1, %xmm1
	movss	total(%rip), %xmm0
	movl	$1000000000, %eax
	cvtsi2sdl	k(%rip), %xmm1
	addsd	.LC0(%rip), %xmm1
	.p2align 4,,10
	.p2align 3
.L2:
	unpcklps	%xmm0, %xmm0
	cvtps2pd	%xmm0, %xmm0
	addsd	%xmm1, %xmm0
	unpcklpd	%xmm0, %xmm0
	cvtpd2ps	%xmm0, %xmm0
	subl	$1, %eax
	jne	.L2
	movss	%xmm0, total(%rip)
	unpcklps	%xmm0, %xmm0
	xorl	%edx, %edx
	cvtps2pd	%xmm0, %xmm0
	ucomisd	.LC1(%rip), %xmm0
	setnp	%dl
	cmove	%edx, %eax
	ret
	.cfi_endproc
.LFE0:
	.size	main, .-main
	.globl	k
	.data
	.align 4
	.type	k, @object
	.size	k, 4
k:
	.long	5
	.globl	total
	.align 4
	.type	total, @object
	.size	total, 4
total:
	.long	1045220557
	.section	.rodata.cst8,"aM",@progbits,8
	.align 8
.LC0:
	.long	0
	.long	1071644672
	.align 8
.LC1:
	.long	858993459
	.long	1070805811
	.ident	"GCC: (GNU) 12.2.0"
	.section	.note.GNU-stack,"",@progbits
```

</Card>

<Card fold title="1-4">

```nasm
	.file	"1.c"
	.text
	.section	.text.startup,"ax",@progbits
	.p2align 4
	.globl	main
	.type	main, @function
main:
.LFB0:
	.cfi_startproc
	vxorps	%xmm1, %xmm1, %xmm1
	vmovss	total(%rip), %xmm0
	movl	$1000000000, %eax
	vcvtsi2sdl	k(%rip), %xmm1, %xmm1
	vaddsd	.LC0(%rip), %xmm1, %xmm1
	.p2align 4,,10
	.p2align 3
.L2:
	vunpcklps	%xmm0, %xmm0, %xmm0
	vcvtps2pd	%xmm0, %xmm0
	vaddsd	%xmm1, %xmm0, %xmm0
	vmovddup	%xmm0, %xmm0
	vcvtpd2psx	%xmm0, %xmm0
	subl	$1, %eax
	jne	.L2
	vmovss	%xmm0, total(%rip)
	vunpcklps	%xmm0, %xmm0, %xmm0
	xorl	%edx, %edx
	vcvtps2pd	%xmm0, %xmm0
	vucomisd	.LC1(%rip), %xmm0
	setnp	%dl
	cmove	%edx, %eax
	ret
	.cfi_endproc
.LFE0:
	.size	main, .-main
	.globl	k
	.data
	.align 4
	.type	k, @object
	.size	k, 4
k:
	.long	5
	.globl	total
	.align 4
	.type	total, @object
	.size	total, 4
total:
	.long	1045220557
	.section	.rodata.cst8,"aM",@progbits,8
	.align 8
.LC0:
	.long	0
	.long	1071644672
	.align 8
.LC1:
	.long	858993459
	.long	1070805811
	.ident	"GCC: (GNU) 12.2.0"
	.section	.note.GNU-stack,"",@progbits
```

</Card>

<Card fold title="2-1">

```nasm
	.file	"2.c"
	.text
	.section	.text.startup,"ax",@progbits
	.p2align 4
	.globl	main
	.type	main, @function
main:
.LFB0:
	.cfi_startproc
	xorl	%eax, %eax
	leaq	a(%rip), %rcx
	leaq	b(%rip), %rdi
	movabsq	$4294967296, %rsi
	.p2align 4,,10
	.p2align 3
.L2:
	movq	%rax, %rdx
	pxor	%xmm0, %xmm0
	addq	$1, %rax
	andl	$1023, %edx
	cvtsd2ss	(%rdi,%rdx,8), %xmm0
	mulss	(%rcx,%rdx,4), %xmm0
	movss	%xmm0, (%rcx,%rdx,4)
	cmpq	%rsi, %rax
	jne	.L2
	cvttss2sil	2048+a(%rip), %eax
	ret
	.cfi_endproc
.LFE0:
	.size	main, .-main
	.globl	a
	.bss
	.align 32
	.type	a, @object
	.size	a, 4096
a:
	.zero	4096
	.globl	b
	.align 32
	.type	b, @object
	.size	b, 8192
b:
	.zero	8192
	.ident	"GCC: (GNU) 12.2.0"
	.section	.note.GNU-stack,"",@progbits
```

</Card>

<Card fold title="2-2">

```nasm
	.file	"2.c"
	.text
	.section	.text.startup,"ax",@progbits
	.p2align 4
	.globl	main
	.type	main, @function
main:
.LFB0:
	.cfi_startproc
	vxorps	%xmm1, %xmm1, %xmm1
	xorl	%eax, %eax
	leaq	a(%rip), %rcx
	movabsq	$4294967296, %rsi
	leaq	b(%rip), %rdi
	.p2align 4,,10
	.p2align 3
.L2:
	movq	%rax, %rdx
	addq	$1, %rax
	andl	$1023, %edx
	vcvtsd2ss	(%rdi,%rdx,8), %xmm1, %xmm0
	vmulss	(%rcx,%rdx,4), %xmm0, %xmm0
	vmovss	%xmm0, (%rcx,%rdx,4)
	cmpq	%rsi, %rax
	jne	.L2
	vcvttss2sil	2048+a(%rip), %eax
	ret
	.cfi_endproc
.LFE0:
	.size	main, .-main
	.globl	a
	.bss
	.align 32
	.type	a, @object
	.size	a, 4096
a:
	.zero	4096
	.globl	b
	.align 32
	.type	b, @object
	.size	b, 8192
b:
	.zero	8192
	.ident	"GCC: (GNU) 12.2.0"
	.section	.note.GNU-stack,"",@progbits
```

</Card>

<Card fold title="2-3">

```nasm
	.file	"2.c"
	.text
	.section	.text.startup,"ax",@progbits
	.p2align 4
	.globl	main
	.type	main, @function
main:
.LFB0:
	.cfi_startproc
	xorl	%eax, %eax
	leaq	a(%rip), %rcx
	leaq	b(%rip), %rdi
	movabsq	$4294967296, %rsi
	.p2align 4,,10
	.p2align 3
.L2:
	movq	%rax, %rdx
	addq	$1, %rax
	andl	$1023, %edx
	movq	(%rdi,%rdx,8), %xmm0
	cvtpd2ps	%xmm0, %xmm0
	mulss	(%rcx,%rdx,4), %xmm0
	movss	%xmm0, (%rcx,%rdx,4)
	cmpq	%rsi, %rax
	jne	.L2
	cvttss2sil	2048+a(%rip), %eax
	ret
	.cfi_endproc
.LFE0:
	.size	main, .-main
	.globl	a
	.bss
	.align 32
	.type	a, @object
	.size	a, 4096
a:
	.zero	4096
	.globl	b
	.align 32
	.type	b, @object
	.size	b, 8192
b:
	.zero	8192
	.ident	"GCC: (GNU) 12.2.0"
	.section	.note.GNU-stack,"",@progbits
```

</Card>

<Card fold title="2-4">

```nasm
	.file	"2.c"
	.text
	.section	.text.startup,"ax",@progbits
	.p2align 4
	.globl	main
	.type	main, @function
main:
.LFB0:
	.cfi_startproc
	xorl	%eax, %eax
	leaq	a(%rip), %rcx
	leaq	b(%rip), %rdi
	movabsq	$4294967296, %rsi
	.p2align 4,,10
	.p2align 3
.L2:
	movq	%rax, %rdx
	addq	$1, %rax
	andl	$1023, %edx
	vmovq	(%rdi,%rdx,8), %xmm0
	vcvtpd2psx	%xmm0, %xmm0
	vmulss	(%rcx,%rdx,4), %xmm0, %xmm0
	vmovss	%xmm0, (%rcx,%rdx,4)
	cmpq	%rsi, %rax
	jne	.L2
	vcvttss2sil	2048+a(%rip), %eax
	ret
	.cfi_endproc
.LFE0:
	.size	main, .-main
	.globl	a
	.bss
	.align 32
	.type	a, @object
	.size	a, 4096
a:
	.zero	4096
	.globl	b
	.align 32
	.type	b, @object
	.size	b, 8192
b:
	.zero	8192
	.ident	"GCC: (GNU) 12.2.0"
	.section	.note.GNU-stack,"",@progbits
```

</Card>

<Card fold title="2-5">

```nasm
	.file	"2.c"
	.text
	.section	.text.startup,"ax",@progbits
	.p2align 4
	.globl	main
	.type	main, @function
main:
.LFB0:
	.cfi_startproc
	xorl	%eax, %eax
	leaq	a(%rip), %rcx
	leaq	b(%rip), %rdi
	movabsq	$4294967296, %rsi
	.p2align 4,,10
	.p2align 3
.L2:
	movq	%rax, %rdx
	addq	$1, %rax
	andl	$1023, %edx
	cvtsd2ss	(%rdi,%rdx,8), %xmm0
	mulss	(%rcx,%rdx,4), %xmm0
	movss	%xmm0, (%rcx,%rdx,4)
	cmpq	%rsi, %rax
	jne	.L2
	cvttss2sil	2048+a(%rip), %eax
	ret
	.cfi_endproc
.LFE0:
	.size	main, .-main
	.globl	a
	.bss
	.align 32
	.type	a, @object
	.size	a, 4096
a:
	.zero	4096
	.globl	b
	.align 32
	.type	b, @object
	.size	b, 8192
b:
	.zero	8192
	.ident	"GCC: (GNU) 12.2.0"
	.section	.note.GNU-stack,"",@progbits
```

</Card>

<Card fold title="2-6">

```nasm
	.file	"2.c"
	.text
	.section	.text.startup,"ax",@progbits
	.p2align 4
	.globl	main
	.type	main, @function
main:
.LFB0:
	.cfi_startproc
	xorl	%eax, %eax
	leaq	a(%rip), %rcx
	movabsq	$4294967296, %rsi
	leaq	b(%rip), %rdi
	.p2align 4,,10
	.p2align 3
.L2:
	movq	%rax, %rdx
	addq	$1, %rax
	andl	$1023, %edx
	vcvtsd2ss	(%rdi,%rdx,8), %xmm0, %xmm0
	vmulss	(%rcx,%rdx,4), %xmm0, %xmm0
	vmovss	%xmm0, (%rcx,%rdx,4)
	cmpq	%rsi, %rax
	jne	.L2
	vcvttss2sil	2048+a(%rip), %eax
	ret
	.cfi_endproc
.LFE0:
	.size	main, .-main
	.globl	a
	.bss
	.align 32
	.type	a, @object
	.size	a, 4096
a:
	.zero	4096
	.globl	b
	.align 32
	.type	b, @object
	.size	b, 8192
b:
	.zero	8192
	.ident	"GCC: (GNU) 12.2.0"
	.section	.note.GNU-stack,"",@progbits
```

</Card>

</Card>

ç”¨äºæµ‹è¯•çš„æœºå™¨æœ‰äº”å°ï¼ŒCPU å‹å·åˆ†åˆ«ä¸ºï¼š

-   A: AMD Ryzen 7 4800H with Radeon Graphics ï¼ˆç¬”è®°æœ¬ï¼‰
-   B: Intel(R) Xeon(R) CPU E5-2670 v2 @ 2.50GHz ï¼ˆHostwindsï¼‰
-   C: Intel(R) Xeon(R) CPU E5-4610 v2 @ 2.30GHz ï¼ˆTHU æ ¡å†…æœåŠ¡å™¨ï¼‰
-   D: Intel(R) Xeon(R) Platinum 8255C CPU @ 2.50GHz ï¼ˆè…¾è®¯äº‘ï¼‰
-   E: Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz ï¼ˆé˜¿é‡Œäº‘ï¼‰

æµ‹è¯•æ—¶ï¼Œå°†ç¨‹åºè¿è¡Œ 10 éï¼Œè®°å½•å…¶ä¸­ç¬¬ 3 çŸ­çš„ç”¨æ—¶ã€‚

<Card fold title="ssh è¿œç¨‹æµ‹è¯•è„šæœ¬">

```bash
#!/bin/bash

eval "$(ssh-agent)"
ssh-add

dir="$(ssh "$1" mktemp -d)"
scp ./*-*.s "$1:$dir"

ssh "$1" 'grep "model name" /proc/cpuinfo | head -n1'

for i in 1-1 1-2 1-3 1-4 2-1 2-2 2-3 2-4 2-5 2-6; do
    echo "$i"
    ssh "$1" gcc "$dir/$i.s" -o "$dir/$i"
    for _ in $(seq 1 10); do
        ssh "$1" /usr/bin/time "$dir/$i"
    done
done

ssh "$1" rm -r "$dir"

ssh-agent -k
```

</Card>

æµ‹è¯•ç»“æœä¸ºï¼š

| ä»£ç /ç”¨æ—¶(s) |  A   |  B   |   C   |  D   |  E   |
| :----------: | :--: | :--: | :---: | :--: | :--: |
|     1-1      | 2.10 | 3.15 | 3.96  | 4.62 | 4.41 |
|     1-2      | 2.10 | 3.11 | 3.95  | 4.61 | 4.42 |
|     1-3      | 3.50 | 3.82 | 4.52  | 5.30 | 5.04 |
|     1-4      | 3.50 | 3.77 | 4.90  | 5.30 | 5.04 |
|     2-1      | 1.62 | 6.47 | 7.22  | 3.59 | 3.43 |
|     2-2      | 1.41 | 6.26 | 7.65  | 4.31 | 4.08 |
|     2-3      | 1.61 | 4.66 | 5.31  | 3.24 | 3.11 |
|     2-4      | 1.61 | 4.76 | 5.69  | 3.59 | 3.43 |
|     2-5      | 1.40 | 9.06 | 10.41 | 7.12 | 6.77 |
|     2-6      | 1.41 | 9.03 | 10.98 | 7.11 | 6.77 |

è¿™æ•°æ®çœŸçš„éå¸¸è®©äººæ€€ç–‘æ˜¯ä¸æ˜¯æµ‹é”™äº†ï¼ˆ

åªèƒ½è¯´æ˜¯å¤§åƒä¸–ç•Œæ— å¥‡ä¸æœ‰ï¼Œæ€§èƒ½ä¼˜åŒ–å®åœ¨æ˜¯å¤ªç„å­¦äº†ï¼ˆ

ä½†æµ‹è¯•ä¼¼ä¹è¡¨æ˜ï¼Œsource in register æ—¶å…³é—­ `use_vector_fp_converts`ã€source in memory æ—¶å¼€å¯ `use_vector_fp_converts`ï¼Œä¹Ÿå°±æ˜¯ MSVC çš„é€‰æ‹©ï¼Œåœ¨æ€»ä½“ä¸Šæ˜¯æ¯”è¾ƒä¼˜çš„ã€‚
